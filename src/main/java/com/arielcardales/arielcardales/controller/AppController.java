package com.arielcardales.arielcardales.controller;

import com.arielcardales.arielcardales.App;
import com.arielcardales.arielcardales.DAO.InventarioDAO;
import com.arielcardales.arielcardales.Entidades.ItemInventario;
import com.arielcardales.arielcardales.Licencia.Licencia;
import com.arielcardales.arielcardales.Licencia.LicenciaManager;
import com.arielcardales.arielcardales.Updates.UpdateConfig;
import com.arielcardales.arielcardales.Updates.UpdateDialog;
import com.arielcardales.arielcardales.Updates.UpdateManager;
import com.arielcardales.arielcardales.Util.Arboles;
import com.arielcardales.arielcardales.Util.Transiciones;
import javafx.application.Platform;
import javafx.concurrent.Task;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.control.*;
import javafx.scene.layout.VBox;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.stage.Stage;
import org.controlsfx.control.Notifications;

import java.net.URI;
import java.sql.SQLException;

public class AppController {

    private ProductoTreeController productoController;

    @FXML
    private VBox contenedorPrincipal;

    private Parent vistaProductos;
    private UpdateManager updateManager;

    @FXML
    public void initialize() {
        // 1. Validar licencia PRIMERO
        if (!validarLicenciaInicial()) {
            // Si no hay licencia v√°lida, mostrar error y cerrar
            return;
        }

        // 2. Cargar la vista principal/hub
        mostrarVistaPrincipal();

        // 3. Inicializar update manager
        updateManager = new UpdateManager();

        // 4. Mostrar info de licencia despu√©s de cargar
        Platform.runLater(this::mostrarInfoLicencia);
    }

    /**
     * Valida la licencia al iniciar la aplicaci√≥n
     * @return true si la licencia es v√°lida, false si debe cerrarse la app
     */
    private boolean validarLicenciaInicial() {
        try {
            boolean licenciaValida = LicenciaManager.validarLicencia();

            if (!licenciaValida) {
                // Mostrar error y cerrar
                Platform.runLater(() -> {
                    Alert alert = new Alert(Alert.AlertType.ERROR);
                    alert.setTitle("Licencia no v√°lida");
                    alert.setHeaderText("No se pudo validar la licencia");
                    alert.setContentText(
                        "El sistema no pudo verificar su licencia.\n\n" +
                        "Posibles causas:\n" +
                        "‚Ä¢ Licencia expirada\n" +
                        "‚Ä¢ Cliente no registrado\n" +
                        "‚Ä¢ Sin conexi√≥n a internet por m√°s de 7 d√≠as\n\n" +
                        "Contacte al administrador del sistema."
                    );
                    alert.showAndWait();
                    Platform.exit();
                });
                return false;
            }

            // Verificar si est√° por expirar (menos de 7 d√≠as)
            long diasRestantes = LicenciaManager.getDiasRestantes();
            if (diasRestantes > 0 && diasRestantes <= 7) {
                Platform.runLater(() -> {
                    Notifications.create()
                        .title("‚ö† Licencia por expirar")
                        .text("Su licencia vence en " + diasRestantes + " d√≠as.\n" +
                              "Contacte al administrador para renovar.")
                        .position(Pos.TOP_RIGHT)
                        .showWarning();
                });
            }

            return true;

        } catch (Exception e) {
            e.printStackTrace();
            Platform.runLater(() -> {
                Alert alert = new Alert(Alert.AlertType.ERROR);
                alert.setTitle("Error del sistema");
                alert.setHeaderText("Error al validar licencia");
                alert.setContentText("Error: " + e.getMessage());
                alert.showAndWait();
                Platform.exit();
            });
            return false;
        }
    }

    /**
     * Muestra informaci√≥n de la licencia actual (solo en modo DEBUG)
     */
    private void mostrarInfoLicencia() {
        Licencia lic = LicenciaManager.getLicencia();
        if (lic != null) {
            String mensaje = LicenciaManager.getMensajeEstado();

            // Solo mostrar en planes DEMO o si est√° en modo offline
            if (lic.getPlan() == Licencia.PlanLicencia.DEMO || LicenciaManager.isModoOffline()) {
                Notifications.create()
                    .title("‚Ñπ Informaci√≥n de Licencia")
                    .text(mensaje + "\nCliente: " + lic.getNombre())
                    .position(Pos.BOTTOM_RIGHT)
                    .hideAfter(javafx.util.Duration.seconds(10))
                    .showInformation();
            }
        }
    }

    /**
     * Carga la vista principal/hub con los m√≥dulos
     */
    private void mostrarVistaPrincipal() {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource("/fxml/principal_home.fxml"));
            Parent vista = loader.load();

            // Obtener el controlador e inyectar referencia a AppController
            PrincipalViewController controller = loader.getController();
            controller.setAppController(this);

            // Aplicar transici√≥n suave
            Transiciones.cambiarVistaConFade(contenedorPrincipal, vista);
        } catch (Exception e) {
            e.printStackTrace();
            mostrarError("Error al cargar vista principal", e.getMessage());
        }
    }

    /** M√©todo gen√©rico: carga r√°pida de vistas simples con transici√≥n fade **/
    private void cargarVista(String rutaFXML) {
        try {
            FXMLLoader loader = new FXMLLoader(getClass().getResource(rutaFXML));
            Parent vista = loader.load();

            // Aplicar transici√≥n suave
            Transiciones.cambiarVistaConFade(contenedorPrincipal, vista);
        } catch (Exception e) {
            e.printStackTrace();
            mostrarError("Error al cargar vista", "No se pudo cargar la vista: " + rutaFXML);
        }
    }

    /**
     * Vuelve a la vista principal/hub (p√∫blico para men√∫)
     */
    @FXML
    private void volverInicio() {
        mostrarVistaPrincipal();
    }

    /**
     * M√©todos p√∫blicos para navegaci√≥n desde PrincipalViewController
     */
    public void mostrarProductosPublic() {
        mostrarProductos();
    }

    public void mostrarVentasPublic() {
        mostrarVentas();
    }

    public void mostrarClientesPublic() {
        mostrarClientes();
    }

    public void mostrarMetricasPublic() {
        mostrarMetricas();
    }

    /** Carga as√≠ncrona de la vista de productos **/
    @FXML
    private void mostrarProductos() {
        contenedorPrincipal.getChildren().clear();

        // Spinner de carga
        ProgressIndicator spinner = new ProgressIndicator();
        spinner.setPrefSize(50, 50);
        Label cargando = new Label("Cargando inventario...");
        VBox box = new VBox(10, spinner, cargando);
        box.setStyle("-fx-alignment: center; -fx-padding: 50;");
        contenedorPrincipal.getChildren().add(box);

        Task<Parent> tareaCarga = new Task<>() {
            @Override
            protected Parent call() throws Exception {
                FXMLLoader loader = new FXMLLoader(App.class.getResource("/fxml/ProductoTree.fxml"));
                Parent vista = loader.load();
                productoController = loader.getController();
                return vista;
            }
        };

        tareaCarga.setOnSucceeded(e -> {
            vistaProductos = tareaCarga.getValue();
            VBox.setMargin(vistaProductos, new Insets(0));

            // Aplicar transici√≥n suave
            Transiciones.cambiarVistaConFade(contenedorPrincipal, vistaProductos);
        });

        tareaCarga.setOnFailed(e -> {
            Label error = new Label("‚ùå Error al cargar vista de productos.");
            contenedorPrincipal.getChildren().setAll(error);
            tareaCarga.getException().printStackTrace();
        });

        new Thread(tareaCarga).start();
    }

    @FXML
    public void verInventarioTree() {
        String[][] columnas = {
                {"Etiqueta", "etiquetaProducto"},
                {"Nombre",   "nombreProducto"},
                {"Color",    "color"},
                {"Talle",    "talle"},
                {"Categor√≠a","categoria"},
                {"Costo",    "costo"},
                {"Precio",   "precio"},
                {"Stock",    "stockOnHand"}
        };

        TextField txtBuscar = new TextField();
        txtBuscar.setPromptText("Buscar (p###, nombre, color, talle)");

        TreeTableView<ItemInventario> tree = Arboles.crearTreeTabla(columnas);
        tree.setShowRoot(false);

        // Carga inicial
        try {
            tree.setRoot(InventarioDAO.cargarArbol(""));
        } catch (SQLException e) {
            e.printStackTrace();
            mostrarError("Error cargando inventario", e.getMessage());
        }

        // Filtrar con reconsulta simple
        txtBuscar.textProperty().addListener((obs, oldV, newV) -> {
            try {
                tree.setRoot(InventarioDAO.cargarArbol(newV));
            } catch (SQLException e) {
                e.printStackTrace();
            }
        });

        VBox layout = new VBox(10, txtBuscar, tree);
        layout.setFillWidth(true);

        contenedorPrincipal.getChildren().setAll(layout);
    }

    /** üîÅ Restaurar inventario sin recargar toda la vista **/
    @FXML
    public void restaurarInventarioCompleto() {
        try {
            if (productoController != null) {
                productoController.restaurarInventarioCompleto();
                System.out.println("Inventario restaurado desde AppController (sin recargar FXML).");
            } else {
                mostrarProductos();
            }
        } catch (Exception e) {
            e.printStackTrace();
            Label error = new Label("‚ùå Error al restaurar inventario");
            contenedorPrincipal.getChildren().setAll(error);
        }
    }

    @FXML
    public void mostrarMetricas() {
        cargarVista("/fxml/metricas.fxml");
    }

    @FXML
    public void mostrarVentas() {
        cargarVista("/fxml/ventas.fxml");
    }

    @FXML
    public void mostrarClientes() {
        cargarVista("/fxml/clientes.fxml");
    }

    @FXML
    private void verInventarioTreeExperimental() {
        cargarVista("/fxml/ProductoTree.fxml");
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SISTEMA DE ACTUALIZACIONES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * Maneja el clic en "Buscar actualizaciones" del men√∫
     */
    @FXML
    private void onBuscarActualizaciones(ActionEvent event) {
        Stage stage = getStage();

        if (stage == null) {
            System.err.println("‚ö†Ô∏è No se pudo obtener Stage, usando ventana dummy");
            stage = new Stage();
        }

        System.out.println("üîç Buscando actualizaciones...");

        final Stage finalStage = stage;
        updateManager.checkForUpdatesAsync()
                .thenAccept(hasUpdate -> {
                    Platform.runLater(() -> {
                        if (hasUpdate) {
                            UpdateDialog.showUpdateAvailable(finalStage, updateManager);
                        } else {
                            UpdateDialog.showInfo(
                                    finalStage,
                                    "Sin actualizaciones",
                                    "Ya est√°s usando la √∫ltima versi√≥n disponible.\n\n" +
                                            "Versi√≥n actual: " + updateManager.getCurrentVersion()
                            );
                        }
                    });
                })
                .exceptionally(error -> {
                    Platform.runLater(() -> {
                        UpdateDialog.showError(
                                finalStage,
                                "Error de conexi√≥n",
                                "No se pudo verificar actualizaciones.\n\n" +
                                        "Verifica tu conexi√≥n a Internet e intenta nuevamente.\n\n" +
                                        "Error: " + error.getMessage()
                        );
                    });
                    return null;
                });
    }

    /**
     * Muestra informaci√≥n "Acerca de"
     */
    @FXML
    private void onAcercaDe(ActionEvent event) {
        Stage stage = getStage();

        String mensaje = String.format(
                "App Inventario - Sistema de Gesti√≥n\n\n" +
                        "Versi√≥n: %s\n" +
                        "Desarrollado con: JavaFX 21 + PostgreSQL\n\n" +
                        "GitHub: github.com/%s/%s",
                updateManager.getCurrentVersion(),
                UpdateConfig.getGithubUser(),
                UpdateConfig.getRepoName()
        );

        UpdateDialog.showInfo(stage, "Acerca de App Inventario", mensaje);
    }

    /**
     * Abre p√°gina de issues en GitHub
     */
    @FXML
    private void onReportarProblema(ActionEvent event) {
        try {
            String url = String.format(
                    "https://github.com/%s/%s/issues/new",
                    UpdateConfig.getGithubUser(),
                    UpdateConfig.getRepoName()
            );

            java.awt.Desktop.getDesktop().browse(new URI(url));

        } catch (Exception e) {
            UpdateDialog.showError(
                    getStage(),
                    "Error",
                    "No se pudo abrir el navegador.\n\n" +
                            "Visita manualmente: github.com/" + UpdateConfig.getGithubUser() +
                            "/" + UpdateConfig.getRepoName() + "/issues"
            );
        }
    }

    /**
     * Obtiene el Stage actual desde el componente FXML
     */
    private Stage getStage() {
        try {
            // Opci√≥n 1: Desde el contenedor principal (m√°s confiable)
            if (contenedorPrincipal != null && contenedorPrincipal.getScene() != null) {
                return (Stage) contenedorPrincipal.getScene().getWindow();
            }

            // Opci√≥n 2: Buscar en ventanas abiertas (fallback)
            return javafx.stage.Window.getWindows().stream()
                    .filter(javafx.stage.Window::isShowing)
                    .filter(w -> w instanceof Stage)
                    .map(w -> (Stage) w)
                    .findFirst()
                    .orElse(null);

        } catch (Exception e) {
            System.err.println("‚ö†Ô∏è No se pudo obtener Stage: " + e.getMessage());
            return null;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NOTIFICACIONES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    /**
     * Muestra notificaci√≥n de √©xito
     */
    private void mostrarExito(String mensaje) {
        Notifications.create()
                .title("‚úÖ √âxito")
                .text(mensaje)
                .position(Pos.BOTTOM_RIGHT)
                .hideAfter(javafx.util.Duration.seconds(3))
                .showConfirm();
    }

    /**
     * Muestra notificaci√≥n de error
     */
    private void mostrarError(String titulo, String mensaje) {
        Notifications.create()
                .title("‚ùå " + titulo)
                .text(mensaje)
                .position(Pos.BOTTOM_RIGHT)
                .hideAfter(javafx.util.Duration.seconds(5))
                .showError();
    }

    /**
     * Muestra notificaci√≥n informativa
     */
    private void mostrarInfo(String mensaje) {
        Notifications.create()
                .title("‚ÑπÔ∏è Informaci√≥n")
                .text(mensaje)
                .position(Pos.BOTTOM_RIGHT)
                .hideAfter(javafx.util.Duration.seconds(4))
                .showInformation();
    }

    /**
     * Muestra notificaci√≥n de advertencia
     */
    private void mostrarAdvertencia(String mensaje) {
        Notifications.create()
                .title("‚ö†Ô∏è Advertencia")
                .text(mensaje)
                .position(Pos.BOTTOM_RIGHT)
                .hideAfter(javafx.util.Duration.seconds(4))
                .showWarning();
    }
}